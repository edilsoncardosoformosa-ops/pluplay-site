async function sha256(e){const t=new TextEncoder;return Array.from(new Uint8Array(await crypto.subtle.digest("SHA-256",t.encode(e)))).map(e=>e.toString(16).padStart(2,"0")).join("")}function loadAllowedUsers(){try{const e=localStorage.getItem("allowedUsers")||"[]",t=JSON.parse(e);return Array.isArray(t)&&t.length>0&&"string"==typeof t[0]?(localStorage.setItem("allowedUsers",JSON.stringify(t.map(e=>({id:e,note:""}))),t):Array.isArray(t)?t:[]}catch(e){return[]}}function saveAllowedUsers(e){localStorage.setItem("allowedUsers",JSON.stringify(e))}function escapeHtml(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function updateStudentPassNotice(){document.getElementById("studentPassNotice").textContent=localStorage.getItem("studentPassHash")?"Senha de aluno definida.":"Nenhuma senha de aluno definida."}function showManageUsers(){document.getElementById("manageUsers").classList.remove("hidden"),renderUserList()}function hideManageUsers(){document.getElementById("manageUsers").classList.add("hidden")}function renderUserList(){const e=document.getElementById("userList");e.innerHTML="",0===allowedUsers.length?e.innerHTML='<li class="muted">Nenhum usuÃ¡rio liberado</li>':allowedUsers.forEach((t,o)=>{const n=document.createElement("li");n.style.marginBottom="6px",n.innerHTML=`<strong>${escapeHtml(t.id)}</strong> â€” ${escapeHtml(t.note||"")} `;const a=document.createElement("button");a.textContent="Revogar",a.className="ghost",a.style.marginLeft="8px",a.onclick=()=>{if(confirm("Revogar este usuÃ¡rio?")){allowedUsers.splice(o,1),saveAllowedUsers(allowedUsers),renderUserList()}};n.appendChild(a),e.appendChild(n)})}function showManageQuestions(){document.getElementById("manageQuestions").classList.remove("hidden"),renderQuestionsList()}function hideManageQuestions(){document.getElementById("manageQuestions").classList.add("hidden")}function renderQuestionsList(){const e=document.getElementById("questionsList");e.innerHTML="",Object.keys(questions).forEach(t=>{const o=document.createElement("div");o.innerHTML=`<strong style="margin-top:8px">${t}</strong>`,e.appendChild(o),questions[t].forEach((n,a)=>{const l=document.createElement("div");l.style.display="flex",l.style.justifyContent="space-between",l.style.alignItems="center",l.style.padding="6px 8px",l.style.borderRadius="6px",l.style.background="#fafafa",l.style.marginTop="6px";const d=document.createElement("div");d.innerHTML=`<div><strong>${escapeHtml(n.q)}</strong></div><div class="muted">${escapeHtml(n.c)}</div>`;const c=document.createElement("div"),i=document.createElement("button");i.textContent="Editar",i.onclick=()=>startEditQuestion(t,a);const s=document.createElement("button");s.textContent="Excluir",s.className="ghost",s.style.marginLeft="8px",s.onclick=()=>{if(confirm("Confirma exclusÃ£o desta questÃ£o?")){questions[t].splice(a,1),localStorage.setItem("questions",JSON.stringify(questions)),renderQuestionsList(),alert("QuestÃ£o excluÃ­da.")}};c.appendChild(i),c.appendChild(s),l.appendChild(d),l.appendChild(c),e.appendChild(l)})})}function showAddQuestion(){editing=null,document.getElementById("addQuestionForm").classList.remove("hidden"),document.getElementById("addQTitle").textContent="Adicionar nova questÃ£o",document.getElementById("newQuestionText").value="",document.getElementById("newQuestionComment").value="",document.getElementById("newQuestionAnswer").value="true"}function hideAddQuestion(){editing=null,document.getElementById("addQuestionForm").classList.add("hidden")}function startEditQuestion(e,t){editing={topic:e,index:t};const o=questions[e][t];document.getElementById("addQTitle").textContent="Editar questÃ£o",document.getElementById("newTopic").value=e,document.getElementById("newQuestionText").value=o.q,document.getElementById("newQuestionComment").value=o.c,document.getElementById("newQuestionAnswer").value=o.a?"true":"false",document.getElementById("addQuestionForm").classList.remove("hidden")}function saveQuestion(){const e=document.getElementById("newTopic").value,t=document.getElementById("newQuestionText").value.trim(),o=document.getElementById("newQuestionComment").value.trim(),n="true"===document.getElementById("newQuestionAnswer").value;if(!t||!o)return alert("Preencha pergunta e comentÃ¡rio."),void 0;questions[e]||(questions[e]=[]),editing?(questions[editing.topic][editing.index]={q:t,a:n,c:o},alert("QuestÃ£o atualizada."),editing=null):(questions[e].push({q:t,a:n,c:o}),alert("QuestÃ£o adicionada.")),localStorage.setItem("questions",JSON.stringify(questions)),document.getElementById("addQuestionForm").classList.add("hidden"),renderQuestionsList()}function showAddBlock(){document.getElementById("addQuestionBlockForm").classList.remove("hidden")}function hideAddBlock(){document.getElementById("addQuestionBlockForm").classList.add("hidden")}function addQuestionBlock(){const e=document.getElementById("newBlockTopic").value,t=document.getElementById("newBlockQuestions").value.trim();if(!t)return alert("Digite ao menos uma linha."),void 0;const o=t.split("\n").map(e=>e.trim()).filter(Boolean);let n=0,a=0;o.forEach(t=>{try{let o=t;o.endsWith(",")&&(o=o.slice(0,-1));const l=Function('"use strict"; return ('+o+")")();if(!l.q||"boolean"!=typeof l.a||!l.c)throw"Formato invÃ¡lido";questions[e]||(questions[e]=[]),questions[e].push(l),n++}catch(e){a++}}),localStorage.setItem("questions",JSON.stringify(questions)),alert(`Bloco processado â€” adicionadas: ${n}, falharam: ${a}`),hideAddBlock(),renderQuestionsList()}function addManualUser(e,t){return allowedUsers.some(t=>t.id===e)?!1:(allowedUsers.push({id:e,note:t}),saveAllowedUsers(allowedUsers),renderUserList(),!0)}function shuffle(e){return e.slice().sort(()=>Math.random()-.5)}function startQuiz(e){let t=questions[e]||[];const o=allowedUsers.some(t=>t.id===userId);o||isMaster||(t=t.slice(0,5));if(0===t.length)return void alert("Sem questÃµes neste tÃ³pico.");const n=parseInt(document.getElementById("numQuestions").value)||10;currentQuestions=shuffle(t).slice(0,n),currentIndex=0,score=0,document.getElementById("menu").style.display="none",document.getElementById("quiz").classList.remove("hidden"),showQuestion()}function showQuestion(){if(currentIndex>=currentQuestions.length)return void endQuiz();const e=currentQuestions[currentIndex];document.getElementById("question").textContent=e.q,document.getElementById("comment").textContent="",document.getElementById("counter").textContent=`QuestÃ£o ${currentIndex+1} de ${currentQuestions.length}`,voiceEnabled&&(u=new SpeechSynthesisUtterance(e.q),u.lang="pt-BR",u.rate=1.3,window.speechSynthesis.cancel(),window.speechSynthesis.speak(u))}function answer(e){const t=currentQuestions[currentIndex],o=(e===t.a?"âœ… Correto! ":"âŒ Errado! ")+(t.c||"");document.getElementById("comment").textContent=o,e===t.a&&score++,voiceEnabled&&(u=new SpeechSynthesisUtterance(o),u.lang="pt-BR",u.rate=1.1,window.speechSynthesis.speak(u))}function nextQuestion(){currentIndex++,showQuestion()}function backToMenu(){document.getElementById("quiz").classList.add("hidden"),document.getElementById("menu").style.display="block"}function endQuiz(){document.getElementById("quiz").classList.add("hidden"),document.getElementById("result").classList.remove("hidden"),document.getElementById("score").textContent=`VocÃª acertou ${score} de ${currentQuestions.length}.`}function restartQuiz(){document.getElementById("result").classList.add("hidden"),document.getElementById("menu").style.display="block"}